<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <record id="view_sale_integration_form" model="ir.ui.view">
            <field name="name">sale.integration.form</field>
            <field name="model">sale.integration</field>
            <field name="inherit_id" ref="integration.view_sale_integration_form" />
            <field name="arch" type="xml">
                <group name="other" position="inside">
                    <field name="use_customer_currency" invisible="not is_integration_shopify" widget="boolean_toggle"/>
                </group>
                <group name="advanced_sales_order_settings" position="inside">
                    <field name="integration_channel_ids" widget="many2many_tags" invisible="not is_integration_shopify" options="{'no_create': True, 'no_edit': True}"/>
                    <div colspan="2">
                        <button name="import_sale_channels" string="Import Sale Channels" type="object" class="btn btn-primary" invisible="not is_integration_shopify" />
                    </div>
                </group>
                <page name="sale_order_page" position="inside">
                    <group string="Sale Order Metafields Mappings"
                           name="sale_order_metafields_mappings"
                           invisible="not is_integration_shopify">
                        <div colspan="2">
                            <p>
                                Use the table below to setup mappings between Shopify order metafields and fields on sale.order model in Odoo.
                            </p>
                            <p>
                                <button name="update_metafields"
                                        string="Update Metafields"
                                        type="object"
                                        class="btn btn-primary"
                                        context="{'external_entity': 'order'}"
                                />
                            </p>
                        </div>
                        <field name="order_metafield_mapping_ids" colspan="2" nolabel="1">
                            <list editable="bottom">
                                <field name="integration_id" column_invisible="1"/> <!-- Required because it is used in the fields domains in the model -->
                                <field name="filtered_odoo_fields" column_invisible="1"/> <!-- Required because it is used in the fields domains in the model -->
                                <field name="metafield_id"
                                       domain="[('type', '=', 'order'), ('integration_id', '=', integration_id)]"
                                       options="{'no_open': True, 'no_create': True}"/>
                                <field name="metafield_key"/>
                                <field name="metafield_type"/>
                                <field name="odoo_field_id"
                                       options="{'no_open': True, 'no_create': True}"
                                       required="metafield_id != False"/>
                            </list>
                        </field>
                    </group>
                </page>

                <page name="customer_default_page" position="inside">
                    <group string="Customer Metafields Mappings"
                           name="customer_metafields_mappings"
                           invisible="not is_integration_shopify">
                        <div colspan="2">
                            <p>
                                Use the table below to setup mappings between Shopify customer metafields and fields on res.partner model in Odoo.
                            </p>
                            <p>
                                <button name="update_metafields"
                                        string="Update Metafields"
                                        type="object"
                                        class="btn btn-primary"
                                        context="{'external_entity': 'customer'}"
                                />
                            </p>
                        </div>
                        <field name="customer_metafield_mapping_ids" colspan="2" nolabel="1">
                            <list editable="bottom">
                                <field name="integration_id" column_invisible="1"/> <!-- Required because it is used in the fields domains in the model -->
                                <field name="filtered_odoo_fields" column_invisible="1"/> <!-- Required because it is used in the fields domains in the model -->
                                <field name="metafield_id"
                                       domain="[('type', '=', 'customer'), ('integration_id', '=', integration_id)]"
                                       options="{'no_open': True, 'no_create': True}"/>
                                <field name="metafield_key"/>
                                <field name="metafield_type"/>
                                <field name="odoo_field_id"
                                       options="{'no_open': True, 'no_create': True}"
                                       required="metafield_id != False"/>
                            </list>
                        </field>
                    </group>
                </page>

                <field name="ignore_vat_validation" position="after">
                    <field name="shopify_customer_language" invisible="not is_integration_shopify"/>
                </field>

                <xpath expr="//group[@name='inventory_location_mapping']/field[@name='location_line_ids']/." position="before">
                    <field name="invalid_location_mapping" invisible="1"/> <!-- Required because it is used in the invisible condition below -->
                    <div class="alert alert-warning mb-1" role="alert" invisible="not invalid_location_mapping" colspan="2">
                        <h4 style="color: inherit"><i class="fa fa-gear"/> Invalid Location Mapping</h4>
                        All e-commerce locations must be mapped to unique Odoo warehouses. Duplicate warehouse mappings are not allowed.
                        Please ensure that each e-commerce location is associated with a distinct Odoo warehouse to avoid configuration issue.
                    </div>
                </xpath>

                <!-- Warning about migration from REST API to GraphQL API -->
                <xpath expr="//div[@name='misc']" position="before">
                    <div name="graphql-migration-warning" class="border border-danger p-4 mb-3" invisible="not is_integration_shopify">
                        <h4 class="text-danger">Important: Migration from Shopify REST API to Shopify GraphQL</h4>
                        <p>
                            Our next release will switch from the Shopify REST API to the new Shopify GraphQL API.
                            Shopify has announced the deprecation of its REST API (effective March 2025),
                            which means they may remove or stop supporting it at any time.
                            This change affects nearly all connector functionality, so we strongly recommend
                            testing the release on a staging server before deploying it to production.
                        </p>

                        <p>
                            If you have questions or encounter any issues, please reach out to our support portal for assistance.
                        </p>

                        <a href="https://support.ventor.tech/" role="button" target="_blank" class="btn btn-outline-danger">
                            Contact Support
                        </a>
                    </div>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
